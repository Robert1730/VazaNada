<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="style.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="../css/dashboards.css">
    <link rel="shortcut icon" href="../assets/icon/IconeVZ.png" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>

<body onload="inicializarPagina()">
    <div class="main-container">      
      <header class="header">
          <h1>Dashboard</h1>
      </header>
        <div class="container_infos_dashboard">
            <aside class= "aside">
                <a href="../index.html"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="#000" class="bi bi-house-fill" viewBox="0 0 16 16">
                  <path d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L8 2.207l6.646 6.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293z"/>
                  <path d="m8 3.293 6 6V13.5a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 2 13.5V9.293z"/>
                </svg></a>
                <div>
                    <h1>Setores</h1>
                    <nav>
                      <a href="#"><span style="color: blue;">Medição</span></a>
                      <a href="#">Regulagem</a>
                      <a href="#">Tratamento </a>
                      <a href="#">Distribuição</a>
                      <a href="#">Interconexão</a>
                      <a href="#">Armazenamento</a>
                    </nav>
                </div>
            </aside>
            <div class="dashboard">
              <div class="sensores-info">
                <div class="sensor-info">
                  <h1>Setor em estado <span style="color: red;">crítico</span></h1>
                  <div>
                   <p><span id="criticoKPI" class="resultadoKPI"></p>
                     
                  </div>
                </div>
                <div class="sensor-info">
                  <h1>Setores <span style="color: rgb(0, 128, 19);">seguros</span></h1>
                  <div>
                    <p><span id="seguroKPI" class="resultadoKPI"></p>
                  </div>
                </div>
                <div class="sensor-info">
                  <h1>Setores em <span style="color: orange;">alerta</span></h1>
                  <div>
                    <p><span id="alertaKPI" class="resultadoKPI"></p>
                  </div>
                </div>
              </div>
    
              <div class="sensores-grafico-1">
                <div class="chart-container1">
                    <h1>Quantidade captada por sensor (%)</h1>
                    <canvas id="myChart"></canvas>
                </div>
                <div class="chart-container2">
                    <h1>Quantidade de vazamento detectados por mês</h1>
                    <!-- <canvas id="myChart2"></canvas> -->
                    <canvas id="barra"></canvas>
                </div>
              </div>
              
              <div class="sensores-grafico-2">
                <h1>Distribuição de Alertas por Setores</h1>
                <p style="font-size: 40px;">
                  <select name="" id="" class="select_mes">
                    <option value="#">Selecione o Mês</option>
                    <option value="janeiro">Janeiro</option>
                    <option value="fevereiro">Fevereiro</option>
                    <option value="março">Março</option>
                    <option value="abril">Abril</option>
                    <option value="maio">Maio</option>
                    <option value="junho">Junho</option>
                    <option value="julho">Julho</option>
                    <option value="agosto">Agosto</option>
                    <option value="setembro">Setembro</option>
                    <option value="outubro">Outubro</option>
                    <option value="novembro">Novembro</option>
                    <option value="dezembro">Dezembro</option>


                  </select>
                <div class="chart-container3">
                   
                    <canvas id="myChart3"></canvas>
                </div>
              </div>
            </div>
        </div>
    </div>

</body>
</html>

<script>


function inicializarPagina() {
    atualizarKPI();
    obterDados();
}

function atualizarKPI(){

  
  fetch("/usuarios/criticoKPI").then(function (resposta) {
            if (resposta.ok) {
              if (resposta.status == 204) {
                    throw "Nenhum resultado encontrado!!";
                }
                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos USUARIOS: ", JSON.stringify(resposta));
                   
                    criticoKPI.innerHTML = "";

                    for (let i = 0; i < resposta.length; i++) {
                // Cria um elemento HTML para exibir cada setor
               
                criticoKPI.innerHTML += `${resposta[i].nome_setor}<br> `; // Adiciona o nome do setor ao parágrafo
                
            }

                });
            } else {
                throw ('Houve um erro na API!');
            }
            }).catch(function (resposta) {
              console.error(resposta);
            });

            fetch("/usuarios/seguroKPI").then(function (resposta) {
            if (resposta.ok) {
              if (resposta.status == 204) {
                    throw "Nenhum resultado encontrado!!";
                }
                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos USUARIOS: ", JSON.stringify(resposta));
                   
                    seguroKPI.innerHTML = "";

                    for (let i = 0; i < resposta.length; i++) {
                // Cria um elemento HTML para exibir cada setor
               
                seguroKPI.innerHTML += `${resposta[i].nome_setor}<br> `; // Adiciona o nome do setor ao parágrafo
                
            }

                });
            } else {
                throw ('Houve um erro na API!');
            }
            }).catch(function (resposta) {
              console.error(resposta);
            });

            fetch("/usuarios/alertaKPI").then(function (resposta) {
            if (resposta.ok) {
              if (resposta.status == 204) {
                    throw "Nenhum resultado encontrado!!";
                }
                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos USUARIOS: ", JSON.stringify(resposta));
                   
                    alertaKPI.innerHTML = "";

                    for (let i = 0; i < resposta.length; i++) {
                // Cria um elemento HTML para exibir cada setor
               
                alertaKPI.innerHTML += `${resposta[i].nome_setor}<br> `; // Adiciona o nome do setor ao parágrafo
                
            }

                });
            } else {
                throw ('Houve um erro na API!');
            }
            }).catch(function (resposta) {
              console.error(resposta);
            });
            
}


function obterDados(){
  // Aqui seria a função que obteria os dados do banco de dados
  // No caso, aqui você colocaria o fetch que teria o endereço da sua rota que você criou na pasta /routes e chamaria a função plotarGraficoLinha nessa função. Exemplo:
 
  // fetch('/obterDados')
  // .then(function(response){
  //   return response.json();
  // })
  // .then(function(data){
  //   plotarGraficoLinha(data);
  //   plotarGraficoBarra(data);
  // })
  // .catch(function(err){
  //   console.log(err);
  // })

  // Como eu não configurei as rotas, eu criei um array com os dados para simular a obtenção dos dados

  var dadosDATA = []
  var dadosQUANTIDADE = []
  
  
  fetch("/usuarios/dashDATA").then(function (resposta) {
            if (resposta.ok) {
              if (resposta.status == 204) {
                    throw "Nenhum resultado encontrado!!";
                }
                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos: ", JSON.stringify(resposta));
                    // resultadoKPI1.innerHTML = `${resposta[0].quantidade_total_usuarios}`
                  
                    for (var i = 0; i < resposta.length; i++) {
                      var diaSelecionado = resposta[i]
                      console.log(diaSelecionado)
                      var data = diaSelecionado.nome_mes 
                      var quantidade = diaSelecionado.quantidade_vazamentos
                      
                      dadosDATA.push(data)
                      dadosQUANTIDADE.push(quantidade)
                    }
                    // Chamando a função para plotar o gráfico de barra com os dados
                    plotarGraficoBarra(dadosDATA, dadosQUANTIDADE)
                  console.log('aa',dadosDATA)
                  console.log('bb', dadosQUANTIDADE)
                });


            } else {
                throw ('Houve um erro na API!');
            }
            }).catch(function (resposta) {
              console.error(resposta);
            });
          

  
 
}

// Função para plotar o gráfico de barra
function plotarGraficoBarra(parametro1, parametro2){

console.log('parametro 1', parametro1)
console.log('parametro 2', parametro2)

// Preenchendo os arrays com os dados


// Capturando o elemento canvas pelo id 
var ctx = document.getElementById('barra').getContext('2d');
// Criando o gráfico de barra usando o Chart.js
var myChart = new Chart(ctx, {
    type: 'bar', // Tipo de gráfico: barra
    data: { // Dados para o gráfico
        labels: parametro1, // Rótulos no eixo X - Mostro as datas
        datasets: [{
            label: 'QtdMês', // Nome do conjunto de dados
            data: parametro2, // Dados dos votos
            backgroundColor: [
                'rgba(255, 99, 132, 0.2)', // Cor de fundo das barras
            ],
            borderColor: [
                'rgba(255, 99, 132, 1)', // Cor da borda das barras
            ],
            borderWidth: 1 // Largura da borda das barras
        }]
    },
});
}

  const labels = [ 
      '7',
      '8',
      '10',
      '11',
      '12',
      '13',
      '14',
      '15', 
      '16',
      '17',
      '18',
      '19',
  ];

  const data = {
      labels: labels,
      datasets: [{
          label:'Sensor 1',
          backgroundColor: 'rgb(108, 229, 232)',
          borderColor: 'rgb(108, 229, 232)',
          data: [6, 12, 15 , 20, 23, 79, 12, 10, 2, 0, ],
      },
      {
        label:'Crítico',
          backgroundColor: 'rgb(255, 0, 0)',
          borderColor: 'rgb(255, 0, 0)',
          data: [75, 75, 75, 75, 75, 75, 75, 75,75, 75,75, 75, ],
      }

    ]


  };

  const config = {
      type: 'line',
      data: data,
      options: {
        scales: {
      y: {
          ticks: {
              callback: function(value) {
                  return value + '%'; 
              }
          }
      },
     x: {
          ticks: {
              callback: function(value) {
                  return value + 'h'; 
              }
          }
      }

  }
      }
      
  };

  // const labels2 = [
  //     'Janeiro',
  //     'Fevereiro',
  //     'Março',
  //     'Abril',
  //     'Maio',
  //     'Junho',
  //     'Julho',
  //     'Agosto', 
  //     'Setembro',
  //     'Outubro',
  //     'Novembro',
  //     'Dezembro',
  // ];

  // const data2 = {
  //     labels: labels2,
  //     datasets: [{
  //         label: 'QtdMês',
  //         backgroundColor: 'rgb(108, 229, 232)',
  //         borderColor: 'rgb(108, 229, 232)',
  //         data: [5, 0, 7, 4, 0, 2, 3, 0, 5, 0, 10, 0, ],
  //     }],

  // }
  
  // const config2 = {
  //     type: 'bar',
  //     data: data2,
  //     options: {}
  // };

  const data3 = {
labels: [
'Setor de Medição ',
'Setor de Tratamento ',
'Setor de Regulagem',
'Setor de Armazenamento',

],
datasets: [{
label: '',
data: [3, 3, 3, 1],
backgroundColor: [
'rgb(108, 229, 232)',
'rgb(8, 77, 110)',
'rgb(45, 139, 280)',
'rgb(130, 95, 250)',

],
hoverOffset: 4
}]
};


  const config3 = {
      type: 'pie',
      data: data3,
      options: {}
  };

  const myChart = new Chart(
      document.getElementById('myChart'),
      config
  );
  // const myChart2 = new Chart(
  //     document.getElementById('barra'),
  //     config2
  // );
  const myChart3 = new Chart(
      document.getElementById('myChart3'),
      config3
  );
</script>