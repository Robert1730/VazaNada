<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="style.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="../css/dashboards.css">
    <link rel="shortcut icon" href="../assets/icon/IconeVZ.png" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>

<body onload="inicializarPagina()">
    <div class="main-container">      
      <header class="header">
          <h1>Dashboard</h1>
      </header>
        <div class="container_infos_dashboard">
            <aside class= "aside">
                <a href="../index.html"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="#000" class="bi bi-house-fill" viewBox="0 0 16 16">
                  <path d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L8 2.207l6.646 6.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293z"/>
                  <path d="m8 3.293 6 6V13.5a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 2 13.5V9.293z"/>
                </svg></a>
                <div>
                    <h1>Setores</h1>
                    <nav class="navAlinhar" >
                      <a href="dashboard.html"><button onclick=""  class="buttonSetor" >Medição</button></a>
                      <a href="#"><button  class="buttonSetor" onclick="trocarRegulagem()">Regulagem</button></a>
                      <a href="#"><button class="buttonSetor" onclick="trocarTratamento()">Tratamento </button></a>
                      
                    </nav>
                </div>
            </aside>
            <div class="dashboard">
              <div class="sensores-info">
                <div class="sensor-info">
                  <h1>Setor em estado <span style="color: red;">crítico</span></h1>
                  <div>
                   <p><span id="criticoKPI" class="resultadoKPI"></p>
                     
                  </div>
                </div>
                <div class="sensor-info">
                  <h1>Setores <span style="color: rgb(0, 128, 19);">seguros</span></h1>
                  <div>
                    <p><span id="seguroKPI" class="resultadoKPI"></p>
                  </div>
                </div>
                <div class="sensor-info">
                  <h1>Setores em <span style="color: orange;">alerta</span></h1>
                  <div>
                    <p><span id="alertaKPI" class="resultadoKPI"></p>
                  </div>
                </div>
              </div>
    
              <div class="sensores-grafico-1">
                <div class="chart-container1">
                    <h1>Quantidade captada por sensor (%)</h1>
                    <canvas style="display: flex;" id="myChart"></canvas>                 
                    <canvas style="display: none;" id="myChartTrocarRegulagem"></canvas>
                    <canvas style="display: none;" id="myChartTrocarTratamento"></canvas>
                </div>
                <div class="chart-container2">
                    <h1>Quantidade de vazamento detectados por mês</h1>
                    <!-- <canvas id="myChart2"></canvas> -->
                    <canvas id="barra"></canvas>
                </div>
              </div>
              
              <div class="sensores-grafico-2">
                <h1>Distribuição de Alertas por Setores</h1>
                <p style="font-size: 40px;">
                  <select id="slt_mesSelecionado" class="select_mes" onchange="obterDados()">
                    <option value="#" selected disabled>Selecione o Mês</option>
                    <option value="01">Janeiro</option>
                    <option value="02">Fevereiro</option>
                    <option value="03">Março</option>
                    <option value="04">Abril</option>
                    <option value="05">Maio</option>
                    <option value="06">Junho</option>
                    <option value="07">Julho</option>
                    <option value="08">Agosto</option>
                    <option value="09">Setembro</option>
                    <option value="10">Outubro</option>
                    <option value="11">Novembro</option>
                    <option value="12">Dezembro</option>
                  </select>
                <div class="chart-container3">
                    <canvas id="graficoMês"></canvas>
                </div>
              </div>
            </div>
        </div>
    </div>

</body>
</html>
<script>

function inicializarPagina() {
    atualizarKPI();
    obterDados();
}

function atualizarKPI(){

  
  fetch("/usuarios/criticoKPI").then(function (resposta) {
            if (resposta.ok) {
              if (resposta.status == 204) {
                    throw "Nenhum resultado encontrado!!";
                }
                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos USUARIOS: ", JSON.stringify(resposta));
                   
                    criticoKPI.innerHTML = "";

                    for (let i = 0; i < resposta.length; i++) {
                // Cria um elemento HTML para exibir cada setor
               
                criticoKPI.innerHTML += `${resposta[i].nome_setor}<br> `; // Adiciona o nome do setor ao parágrafo
                
            }

                });
            } else {
                throw ('Houve um erro na API!');
            }
            }).catch(function (resposta) {
              console.error(resposta);
            });

            fetch("/usuarios/seguroKPI").then(function (resposta) {
            if (resposta.ok) {
              if (resposta.status == 204) {
                    throw "Nenhum resultado encontrado!!";
                }
                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos USUARIOS: ", JSON.stringify(resposta));
                   
                    seguroKPI.innerHTML = "";

                    for (let i = 0; i < resposta.length; i++) {
                // Cria um elemento HTML para exibir cada setor
               
                seguroKPI.innerHTML += `${resposta[i].nome_setor}<br> `; // Adiciona o nome do setor ao parágrafo
                
            }

                });
            } else {
                throw ('Houve um erro na API!');
            }
            }).catch(function (resposta) {
              console.error(resposta);
            });

            fetch("/usuarios/alertaKPI").then(function (resposta) {
            if (resposta.ok) {
              if (resposta.status == 204) {
                    throw "Nenhum resultado encontrado!!";
                }
                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos USUARIOS: ", JSON.stringify(resposta));
                   
                    alertaKPI.innerHTML = "";

                    for (let i = 0; i < resposta.length; i++) {
                // Cria um elemento HTML para exibir cada setor
               
                alertaKPI.innerHTML += `${resposta[i].nome_setor}<br> `; // Adiciona o nome do setor ao parágrafo
                
            }

                });
            } else {
                throw ('Houve um erro na API!');
            }
            }).catch(function (resposta) {
              console.error(resposta);
            });
            
}


function obterDados(){
  // Gráfico Barra

  var dadosDATA = []
  var dadosQUANTIDADE = []
  
  
  fetch("/usuarios/dashDATA").then(function (resposta) {
            if (resposta.ok) {
              if (resposta.status == 204) {
                    throw "Nenhum resultado encontrado!!";
                }
                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos: ", JSON.stringify(resposta));
                    // resultadoKPI1.innerHTML = ${resposta[0].quantidade_total_usuarios}
                  
                    for (var i = 0; i < resposta.length; i++) {
                      var diaSelecionado = resposta[i]
                      console.log(diaSelecionado)
                      var data = diaSelecionado.nome_mes 
                      var quantidade = diaSelecionado.quantidade_vazamentos
                      
                      dadosDATA.push(data)
                      dadosQUANTIDADE.push(quantidade)
                    }
                    // Chamando a função para plotar o gráfico de barra com os dados
                    plotarGraficoBarra(dadosDATA, dadosQUANTIDADE)
                  console.log('aa',dadosDATA)
                  console.log('bb', dadosQUANTIDADE)
                });


            } else {
                throw ('Houve um erro na API!');
            }
            }).catch(function (resposta) {
              console.error(resposta);
            });

 // Grafico Linha

 var dadosHORARIO = []
 var dadosQUANTIDADElinha = []  


  fetch("/usuarios/dashLINHA").then(function (resposta) {
            if (resposta.ok) {
              if (resposta.status == 204) {
                    throw "Nenhum resultado encontrado!!";
                }
                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos: ", JSON.stringify(resposta));
                    // resultadoKPI1.innerHTML = ${resposta[0].quantidade_total_usuarios}
                  
                    for (var i = 0; i < resposta.length; i++) {
                      var diaSelecionado = resposta[i]
                      console.log(diaSelecionado)
                      var hora = diaSelecionado.horario 
                      var quantidade = diaSelecionado.qtdGasVazado
                      
                      dadosHORARIO.push(hora)
                      dadosQUANTIDADElinha.push(quantidade)
                    }
                    // Chamando a função para plotar o gráfico de barra com os dados
                    plotarGraficoLinha(dadosHORARIO, dadosQUANTIDADElinha)
                  console.log('aa',dadosHORARIO)
                  console.log('bb', dadosQUANTIDADElinha)
                });


            } else {
                throw ('Houve um erro na API!');
            }
            }).catch(function (resposta) {
              console.error(resposta);
            });
          
  // Gráfico pizza 
            
    var listaSetor = []
    var listaQuantidade = []

    var mesAtual = new Date().getMonth() + 1
    var mesVar = mesAtual.toString().padStart(2, '0')
    var mesSelecionado = slt_mesSelecionado.value

    if (Number(mesVar) != Number(mesSelecionado) && mesSelecionado != '#') {
      mesVar = mesSelecionado
    }

        fetch("/usuarios/mostrarPizza", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
              mesServer: mesVar,  
            }),
    
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO entrar()!")
            resposta.json().then(json => {
                // Pegando a resposta do Banco de dados
                var listaValores = json.listaFinal;
    
                // Listas para salvar o tipo e a quantidade
    
                for(var cont = 0; cont < listaValores.length; cont++) {
                    var quantidadeAtual = listaValores[cont].Quantidade;
                    var setorAtual = listaValores[cont].Setor;
    
                    listaSetor.push(setorAtual);
                    listaQuantidade.push(quantidadeAtual);
                    
                }  // Chamando a função para plotar o gráfico de barra com os dados
                plotarGraficoPizza(listaSetor, listaQuantidade)
            })
    })
 


}

// Função para plotar o gráfico de barra
function plotarGraficoBarra(parametro1, parametro2){

console.log('parametro 1', parametro1)
console.log('parametro 2', parametro2)

var ctx = document.getElementById('barra').getContext('2d');

var myChart = new Chart(ctx, {
    type: 'bar',                        // Tipo de gráfico: barra
    data: {                           
        labels: parametro1,             // Rótulos no eixo X 
        datasets: [{
            label: 'Quantidade de Vazamentos', // Nome do conjunto de dados
            data: parametro2, // Dados dos votos
            // backgroundColor: [
            //     'rgba(255, 99, 132, 0.2)', // Cor de fundo das barras
            // ],
            // borderColor: [
            //     'rgba(255, 99, 132, 1)', // Cor da borda das barras
            // ],
            backgroundColor: 'rgb(108, 229, 232)',
            borderColor: 'rgb(108, 229, 232)',
            borderWidth: 1              // Largura da borda das barras
        }]
    },
});

}

function plotarGraficoLinha(parametro1, parametro2){

  var ctx = document.getElementById('myChart').getContext('2d');

                                                          // Criando o gráfico com as alterações solicitadas
var myChart = new Chart(ctx, {
    type: 'line',                                         // Tipo de gráfico: linha
    data: {
        labels: parametro1, 
        datasets: [{
            label: 'Sensor 1', 
           data: parametro2, 
            backgroundColor: 'rgb(108, 229, 232)',         // Cor da linha
            borderColor: 'rgb(108, 229, 232)',             // Cor da borda
            borderWidth: 1                                 // Largura da borda da linha
        },{
        label:'Crítico',
          backgroundColor: 'rgb(255, 0, 0)',
          borderColor: 'rgb(255, 0, 0)',
          data: new Array(parametro2.length).fill(60),
            borderWidth: 2,
            fill: false,
            tension:0,
            pointRadius: 0,
            borderDash: [5, 5]
      }
      ]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: false,         // Impede que o eixo Y comece do zero, se necessário
                min: 0,                     // Define um valor mínimo fixo para o eixo Y, ajuste conforme necessário
                max: 100,                   // Define um valor máximo fixo para o eixo Y, ajuste conforme necessário
                ticks: {
                    stepSize: 10            // Define o intervalo dos valores no eixo Y (exemplo: 0, 10, 20, etc.)
                },
                
                ticks: {
                callback: function(value) {
                  return value + '%'; 
              }
          
      },
            },
            x: {
                   
                labels: parametro1,     
                title: {
                    display: true,
                    text: 'Horários'    
                }
            }
        }
    }, 
    
});

}

function plotarGraficoPizza(setores, quantidades) {
    var ctx = document.getElementById('graficoMês').getContext('2d');
    
    // Verifica se já existe um gráfico e destrói o anterior
    if (window.GraficoPizza) {
        window.GraficoPizza.destroy();
    }

    // Cria o novo gráfico
    window.GraficoPizza = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: setores,
            datasets: [{
                label: 'Distribuição de Alertas por Setores',
                data: quantidades,
                backgroundColor: ['#3d96a5', '#00FF00', '#FF8C00', '#0000FF'],
                borderColor: ['#FFFFFF', '#FFFFFF', '#FFFFFF', '#FFFFFF'],
                borderWidth: 1
            }]
        }
        
      
    });
}



  const grafico_geral = document.getElementById('myChartTrocarRegulagem');
  const grafico_geral2 = document.getElementById('myChartTrocarTramento');
</script>

<script>
  function trocarRegulagem(){

    document.getElementById('myChartTrocarRegulagem').style.display="flex";
    document.getElementById('myChart').style.display="none";
    document.getElementById('myChartTrocarTratamento').style.display="none";
    
  const labels = [ 
      '7',
      '8',
      '10',
      '11',
      '12',
      '13',
      '14',
      '15', 
      '16',
      '17',
      '18',
      '19',
  ];

  const data = {
      labels: labels,
      datasets: [{
          label:'Sensor 1',
          backgroundColor: 'rgb(108, 229, 232)',
          borderColor: 'rgb(108, 229, 232)',
          data: [2, 20, 10 , 35, 23, 64, 12, 10, 2, 0, ],
      },
      {
        label:'Crítico',
          backgroundColor: 'rgb(255, 0, 0)',
          borderColor: 'rgb(255, 0, 0)',
          data: new Array(labels.length).fill(60),
        borderWidth: 2,
        fill: false,
        tension:0,
        pointRadius: 0,
        borderDash: [5, 5]
      }

    ]


  };

  const config = {
      type: 'line',
      data: data,
      options: {
        scales: {
      y: {
          ticks: {
              callback: function(value) {
                  return value + '%'; 
              }
          }
      },
     x: {
          ticks: {
              callback: function(value) {
                  return value + 'h'; 
              }
          }
      }

  }
      }
      
  };

  const myChart = new Chart(
      document.getElementById('myChartTrocarRegulagem'),
      config
  );

    }

    function trocarTratamento(){

      document.getElementById('myChartTrocarRegulagem').style.display="none";
      document.getElementById('myChart').style.display="none";
      document.getElementById('myChartTrocarTratamento').style.display="flex";


    

    
  const labels = [ 
      '7',
      '8',
      '10',
      '11',
      '12',
      '13',
      '14',
      '15', 
      '16',
      '17',
      '18',
      '19',
  ];

  const data = {
      labels: labels,
      datasets: [{
          label:'Sensor 1',
          backgroundColor: 'rgb(108, 229, 232)',
          borderColor: 'rgb(108, 229, 232)',
          data: [2,40, 50 , 67, 23, 65, 12, 10, 2, 5,2,0 ],
      },
      {
        label:'Crítico',
          backgroundColor: 'rgb(255, 0, 0)',
          borderColor: 'rgb(255, 0, 0)',
        data: new Array(labels.length).fill(60),
        borderWidth: 2,
        fill: false,
        tension:0,
        pointRadius: 0,
        borderDash: [5, 5]
        
      }

    ]


  };

  const config = {
      type: 'line',
      data: data,
      options: {
        scales: {
      y: {
          ticks: {
              callback: function(value) {
                  return value + '%'; 
              }
          }
      },
     x: {
          ticks: {
              callback: function(value) {
                  return value + 'h'; 
              }
          }
      }

  }
      }
      
  };





  const myChart = new Chart(
      document.getElementById('myChartTrocarTratamento'),
      config
  );
    }


</script>
